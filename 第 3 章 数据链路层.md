# 第 3 章 数据链路层 #

### 数据链路层的一些基本概念 ###

#### 数据链路层的地位 ####

下面简述两个主机通过互联网进行通信时数据链路层所处的地位

图（a）表示用户主机H1通过电话线上网，中间经过三个路由器连接到远程主机H2，并且经过了多种网络（电话网、局域网...）。当主机H1向H2发送数据时，从协议的层次上看，数据的流动如图（b）。主机都有完整的协议栈，路由器只拥有下面的三层协议栈。数据进入路由器后要先从物理层上升到网络层，在转发表中找到下一跳的地址后，再下到物理层转发出去（如图（b）中的箭头所示）

![p6]

但当我们研究数据链路层的问题时，我们可以只关心在协议栈中水平方向的各数据链路层。因此，当主机H1向H2发送数据时，我们可以想象数据就是在数据链路层从左到右依次传送，如下图：

![p7]

#### 数据链路层使用的信道 ####

数据链路层使用的信道主要有以下两种类型：

1、点对点信道

这种信道使用一对一的点对点通信方式（通信两点之间只有一条物理线路，没有其他任何结点）

2、广播信道

这种信道使用一对多的广播通信方式。广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据发送

#### 链路和数据链路 ####

1、链路

所谓链路就是从一个结点到相邻结点的一段物理线路，而中间没有任何其他的交换结点。在进行数据通信时，两个计算机间的通信路径往往要经过许多段这样的链路

2、数据链路

要想在一段链路上传送数据，那么还必须有一些必要的通信协议来控制这些数据的传输。若把实现这些协议的硬件或软件加到链路上，就构成了数据链路

### 数据链路层要解决的三个基本问题 ###

数据链路层要解决的三个基本问题是：封装成帧、透明传输、差错检测。下面分别阐述。

1、封装成帧

网络层的IP数据报传送到数据链路层就成为帧的数据部分，在帧的数据部分的前面和后面分别添加上首部和尾部，构成了一个完整的帧。如下图：

![p1]

由上图可见。帧长等于数据部分的长度加上帧首部和尾部的长度。在发送帧时，是从帧的首部开始发送。帧的数据部分的长度上限称为最大传输单元MTU

帧的首部和尾部的一个重要作用就是进行帧定界。一般以ASCLL表中的控制字符SOH与EOT作为帧的首部与尾部。控制字符SOH（Start Of Header)放在帧的最前面表示帧的首部，另一个控制字符EOT（End Of Transmission)表示帧的尾部（SOH与EOT是控制字符在ASCLL表中的名字，在实际的帧中他们分别以二进制`00000001`与`00000100`出现）。如下图所示：

![p2]

接收端在收到帧后，只有当帧的首部SOH和尾部EOT都健在时接收端才会认为这是一个完整的帧，应当收下。如果数据在传输过程中出现了错误，接收端收到的帧中缺少SOH或EOT，那么接收端就知道这不是一个完整的帧，应该丢弃。

2、透明传输

所谓透明传输就是指，无论何种数据都能使用“1、封装成帧”中的方式将其封装为帧进行传输。

要想做到透明传输，那么所传输的数据中的任何8比特的组合一定不允许和用作帧定界的控制字符的比特编码一样，否则就会出现帧定界错误。如下图所示，如果数据中的某个字节的二进制代码恰好和SOH或EOT这种控制字符一样，数据链路层就会错误的“找到帧边界”，把部分帧收下（误认为是一个完整的帧），而把剩下的那部分数据丢掉,这就是不透明传输。

![p3]

为了解决上述问题做到透明传输，就必须设法使数据中可能出现的控制字符SOH和EOT在接收端不被解释为帧定界符。具体方法是：发送端的数据链路层在数据中出现控制字符SOH和EOT的前面插入一个转义字符ESC。而在接收端的数据链路层在将数据送往网络层之前删除这个插入的转义字符。这种方法称为字节填充或字符填充。如果转义字符也出现在数据中，那么解决方法仍然是在转义字符前面再插入一个转义字符。因此，当接收端收到连续的两个转义字符时，就删除其中前面的一个。如下图：

![p4]

3、差错检测

现实中的通信线路不是理想的，因此比特在传输过程中可能会产生差错——即1可能变成0，0可能变成1。这就叫做比特差错。在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率BER（Bit Error Rate）。因此，为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测技术。目前在数据链路层广泛使用了循环冗余检验CRC（Cyclic Redundancy Check）的差错检测技术。

CRC的原理如下：

![p5]

上图中，A是由收发双发协商确定的n位二进制数，B是要发送的数据。CRC要做的就是在B后面添加“n-1”个0，然后用添加了0的数据除以A，得到余数D。D就被称为冗余码或帧检验序列FCS（Frame Check Sequence），在发送数据B时，就会将该冗余码添加到B后面发送出去（即实际发送的数据是`101001001`）。接收端收到数据后，会将数据以帧为单位进行CRC检验：把收到的每一个帧都除以A，然后检查得到的余数，如果余数为0则无差错，余数不为0则表示出错，就丢弃。

### 使用点对点信道的数据链路层 ###

下面介绍点对点协议PPP（Point-to-Point Protocol）。PPP是点对点通信时，数据链路层所使用的协议。具体来说就是用户计算机和ISP进行通信时所使用的数据链路层协议。

下面详述PPP的特点、帧格式、工作状态

#### PPP的特点 ####

1、PPP协议应满足的要求

(1)、封装成帧

PPP协议必须规定特殊的字符作为帧定界符，以便使接收端从收到的比特流中能够准确的找出帧开始和结束的位置

(2)、透明性

即如果数据中碰巧出现了和帧定界符一样的比特组合时，必须采取措施解决这个问题

(3)、多种网络层协议

PPP协议必须能够在同一条物理链路上同时支持多种网络层协议（如IP或IPX）的运行。即使用该条物理线路的两端可以使用任何网络层协议进行通信，比如一会儿使用的是IP，一会儿使用的是IPX

(4)、多种类型链路

即PPP能够在多种链路上运行（如光纤、双绞线等）

(5)、差错检测

即PPP能够对接收端收到的帧进行CRC差错检测并丢弃有差错的帧。需要注意的是，PPP只进行检错并丢弃错误包，但不进行纠错。因此PPP是不可靠传输协议

(6)、检测连接状态

即检测链路是否处于正常的工作状态

(7)、最大传送单元

即设置最大传送单元MTU的默认值

(8)、网络层地址协商

即能够协商通信双方网络层的地址

(9)、数据压缩协商

即协商使用何种数据压缩算法，以便接收方能够使用对应的方法解压

2、PPP不需要的功能

(1)、纠错。PPP只进行检错，纠错由TCP负责

(2)、流量控制。流量控制由TCP负责

3、PPP协议的组成

PPP协议由如下三部分组成：

(1)、高级数据链路控制协议HDLC（High-Level Data Link Control）。这是一种对来自网络层的数据进行帧封装的规范

(2)、用来建立、配置和测试数据链路连接的链路控制协议LCP（Link Control Protocol）

(3)、一套网络控制协议NCP（Network Control Protocol），其中的每一个协议支持不同的网络层协议，如IP、OSI的网络层。

![p8]

#### PPP的帧格式 ####

1、字段的意义

PPP的帧格式如下图所示。PPP帧的首部和尾部分别为四个字段和两个字段。

首部的第一个字段和尾部的倒数第一个字段都是标志字段F（Flag），规定为0X7E（0X表示十六进制）。标志字段表示一个帧的开始和结束，因此标志字段就是PPP帧的定界符

首部中的地址字段A规定为0XFF，控制字段C规定为0X0。但这两个字段在PPP帧中并没实际意义

首部的第四个字段是2字节的协议字段，用以标明“信息部分”中装的是什么数据（如协议字段为0X0021时，表明信息部分中装的是IP数据报；协议字段为0XC021时，表明信息部分中装的是LCP数据）

尾部中的倒数第二个字段是CRC的帧检验序列FCS

2、0比特/字节填充

当“信息部分”中出现和标志字段一样的比特组合时（0X7E），就必须采取一些措施使这种形式上和标志字段一样的比特组合不出现在信息部分中，方法就是字节/比特填充。这也就是前面所说的透明传输。

在PPP使用异步传输（逐个字符传送）和同步传输（一连串的比特连续传送）时，分别使用的是字节填充和比特填充。具体如下：

(1)、字节填充

当PPP使用异步传输时，它把转义符定义为0X7D，并使用字节填充。填充方法如下：

- 把信息字段中出现的每一个0X7E字节转变为2字节序列（0X7D，0X5E）
- 把信息字段中出现一个0X7D的字节（即出现了和转义字符一样的比特组合），则把0X7D转变为2字节序列（0X7D，0X5D）
- 若信息字段中出现ASCLL码的控制字符，则在该字符前面要加入一个0X7D字节，同时将该字符的编码加以改变

(2)、0比特填充

具体做法是：在发送端先扫描整个信息字段，只要发现有5个连续1，则立即填入一个0。接收端在收到一个帧时，先找到标志字段F以确定一个帧的边界，接着再用硬件对其中的比特流进行扫描，每当发现五个连续1时，就把这五个连续1后面的一个0删除，以还原为原来的数据。

#### PPP协议的工作状态 ####

在此通过PPP链路的整个初始化过程来阐述PPP协议的工作状态。PPP协议的状态图如下所示：

![p10]

当用户PC呼叫路由器时（即连接某个WIFI），路由器就能检测到PC发出的信号，由此双发便建立了物理层连接。此时PPP就进入**链路建立**状态

然后双方通过LCP协商一些配置选项，即发送LCP的配置请求帧。该帧的协议字段置为LCP对应的代码，而信息字段包含特定的配置请求。LCP的配置选项包括链路上的最大帧长、所使用的鉴别协议规约，以及不使用PPP协议帧中的地址和控制字段（因为前面说了，这两个字段的值并没有实际意义）。协商结束后，双方就建立了LCP链路，此时PPP进入**鉴别**状态（用于鉴别的协议有PAP(Password Authentication Protocol)、CHAP(Challenge-Handshake Authentication Protocol)等）

若鉴别身份失败则转入**链路终止**状态。若鉴别成功则进入**网络层协议**状态

在网络层协议状态，PPP链路的两端的网络控制协议NCP根据网络层的不同协议互相交换网络层特定的网络控制分组。如在PPP链路上运行的是IP协议，则对PPP链路的每一端配置IP协议模块（如分配IP地址）时就要使用NCP中支持IP的协议——IP控制协议IPCP

当网络层配置完毕后，链路就进入可进行数据通信的**链路打开**状态

数据传输结束后，可以由链路的一端发出终止请求LCP分组请求终止链路连接，在收到对方发来的终止确认LCP分组后，转到链路终止状态。当PC向路由器发送信号停止时，则回到链路静止状态

### 使用广播信道的数据链路层 ###

广播信道可进行一对多的通信。例如在局域网中，当一台计算机发送数据时，局域网上的计算机都能检测到这个数据，这就是广播通信。

局域网使用的就是广播信道。因此本节就基于局域网，对广播信道的数据链路层相关知识进行阐述。我们会首先讲解局域网的拓扑结构和特点；然后讨论计算机是如何连接到局域网上的；最后详述如何在局域网这样的广播信道上实现一对一通信。

#### 局域网的拓扑结构和特点 ####

局域网按拓扑结构可分为星形、环形、总线形、树形，分别对应下图中的(a)、(b)、(c)、(d)

![p11]

局域网具有以下特点：

- 局域网一般是为一个单位所有，因此地理范围和站点（主机）数目均受限
- 局域网使用的是广播信道
- 局域网上的主机共享信道，因此面临的一个问题就是，如何使众多主机共享信道但不发生冲突。为解决该问题，局域网采取的是多点接入(multiple access)（又称为动态媒体接入控制）中的随机接入技术
- 局域网使用的是无连接工作方式，即通信双方不必建立连接便直接发送数据。因此局域网提供的服务是不可靠交付。这样做的理由是局域网信道的质量很好，因通信质量不好产生错误的概率很小

> 随机接入技术是指所有主机都可以随机地发送信息。但面临的问题是：如果恰巧多个用户在同一时刻发送信息，那么在共享信道上就会发生冲突（也就是说，局域网中某一时刻只允许一对主机相互通信）。为解决冲突，人们便引入了防碰撞协议CSMA/CD

#### 计算机如何连接局域网 ####

计算机与局域网的连接是通过适配器（即网卡，现今的计算机已经将网卡嵌入到了主板）。

在适配器上面装有处理器和存储器（包括RAM和ROM）。适配器和局域网间的通信是通过电缆或双绞线以串行传输方式进行的，而适配器与计算机间的通信则是通过计算机主板上的I/O总线以并行传输方式进行的。因此，适配器的一个重要功能就是要进行数据串行传输和并行传输间的转换。由于网络上的数据率和计算机总线上的数据率并不相同，因此在适配器其中必须装有对数据进行缓存的存储芯片。在主板上插入适配器时，还必须吧管理该适配器的设备驱动程序安装到计算机的操作系统上，这个驱动程序以后就会告诉适配器，应当从存储器的什么位置上将多长的数据块发送到局域网上，或者应当在存储器的什么位置上把局域网传送过来的数据块存储下来

适配器发送和接收各种帧时不使用计算机的CPU（前面说了，适配器带有处理器）。这时CPU可以处理其他任务。当适配器收到有差错的帧时，就把这个帧丢弃而不必通知计算机。当适配器收到正确的帧时，它就使用中断来通知计算机并交付给协议栈中的网络层。当计算机要发送IP数据报时，就由协议栈把IP数据报向下交给适配器，组装成帧后发送到局域网

> 计算机的硬件地址（即MAC地址）就在适配器的ROM中，而计算机的IP地址则在计算机的存储器中

#### 实现广播信道中的一对一通信 ####

要实现广播信道中的一对一通信，需要解决两个问题。一是，如何做到一对一；二是，如何防止冲突碰撞（前面局域网的特点中已经说了，共享信道会发生碰撞）。下面就从这两个问题入手进行阐释：

1、实现一对一

为了在广播信道上实现一对一通信，可以使每一台计算机的适配器拥有一个与其他适配器都不同的地址（即MAC地址）。在发送数据帧时，在帧的首部写明接收站的MAC地址。仅当数据帧中的目的MAC地址与适配器ROM中存放的MAC地址一致时，该适配器才接受该数据，适配器对不是发送给自己的数据帧就丢弃

2、防止冲突碰撞

防冲突碰撞的方法是采用CSMA/CD协议。它是载波监听多点接入/碰撞检测的缩写。该协议的核心在于载波监听和碰撞检测（前面的局域网的特点中已叙述了多点接入）。具体如下：

- 载波监听就是“发送前先监听”，即每一个站在发送数据前先要检测一下信道上是否有其他站在发送数据，如果有，则暂时不要发送数据，要等到信道变为空时再发送信息
- 碰撞检测就是“边发送边监听”，即适配器边发送数据边检测信道上的信号电压的变化情况，以便判断自己在发送数据时其他站点是否也在发送数据。当几个站点同时发送数据时，信道上的电压变化幅度将会增大。当适配器检测到信号电压变化幅度超过一定的门限值时，就认为总线上还有其他站在发送数据，表明产生了碰撞，适配器就立即停止发送，然后等待一段随机时间后再次发送

### 局域网中的帧结构 ###

> 先阐明一点：目前的局域网基本都使用以太网技术，因此本章的局域网与以太网是等价的

前面详述了点对点通信时的帧结构，现在我们讨论局域网中的帧结构（我们称局域网中的帧为MAC帧）

局域网中的帧结构如下图所示：

![p12]

其由五个字段组成。前两个字段分别为6字节长的目的地址和源地址字段。第三个字段是两字节的类型字段，用来标识上一层使用的是什么协议，以便把收到的MAC帧的数据上交给上一层的这个协议（例如，类型字段的的值为0X0800时，就表示上层使用的是IP数据报）。第四个字段是数据字段，其长度在46-1500字节之间（46字节是这样得出的：MAC帧的最小长度64字节减去18字节的首部和尾部就得出数据字段的最小长度）。最后一个字段是4字节的帧校验序列FCS（使用CRC检测）

### 在数据链路层扩展以太网 ###

网桥工作在数据链路层，在数据链路层扩展以太网要通过网桥实现。下面我们对网桥的作用、工作原理等进行阐述。

1、网桥的作用

网桥的作用就是根据MAC帧的目的地址对收到的帧进行转发和过滤（“过滤”是指网桥会丢掉不需要由它转发的帧）

再在此补充一个概念——网段。网桥将多个以太网连接到一起，构成一个覆盖范围更大的以太网，而原来的每个以太网就称为一个网段。如下图中的三个红色方框各自就是一个网段

2、网桥的工作原理

概括来说，网桥的工作原理为如下三步：

(1)、最开始，网桥中的转发表为空
(2)、自学习。网桥收到帧后先进行自学习。查找转发表中与收到帧的源地址有无匹配的项目。如没有，就在转发表中增加一个项目（源地址和进入的接口）
(3)、转发帧。查找转发表中与收到帧的目的地址有无相匹配的项目。若没有则通过所有其他接口（但进入网桥的接口除外）转发。若有，则按转发表中给出的接口进行转发。但应注意，若转发表中给出的接口就是该帧进入网桥的接口，则应丢弃这个帧（因为这时不需要网桥进行转发）

具体内容如下：

![p13]

(1)、A向B发送帧。连接在同一个局域网上的站点B和网桥B1都能收到A发送的帧。网桥B1先按源地址A查找转发表，B1的转发表中没有A的地址，于是将地址A和收到此帧的接口1写入转发表中。这就表示以后收到要发给A的帧，就应当从这个接口1转发出去。接着再按目的地址B查找转发表，转发表中没有B的地址，于是就通过除收到此帧的接口1以外的所有接口（现在就是接口2）转发该帧。网桥B2从其接口1收到这个转发过来的帧。

网桥B2按同样的方式处理收到的帧。B2的转发表中没有A的地址，因此在转发表中写入地址A和接口1。B2的转发表中没有B的地址，因此B2通过除接受此帧的接口1以外的所有接口（现在就是接口2）转发这个帧

至此，两个转发表中已经各有一个项目了。同时应注意，B本来可以直接收到A发送的帧，为什么还要要网桥B1和B2盲目的转发这个帧呢？这是因为，这两个网桥才接入网路时转发表还为空，它们还不知道B可以收到A的帧。而经过一段时间的工作后，它们的转发表构建完成了，这是它们便不会再盲目的转发帧了（往下看...）

(2)、F向C发送帧。网桥B2从其接口2收到这个帧。B2的转发表中没有F，因此在转发表中写入地址F和接口2。B2的转发表中没有C，因此要通过B2的接口1把帧转发出去。现在C和网桥B1都能收到这个帧。在网桥B1的转发表中没有F，因此要把地址F和接口2写入转发表，并且还要从B1的接口1转发这个帧

(3)、B向A发送帧。网桥B1从其接口1收到这个帧。B1的转发表中没有B，因此在转发表中写入地址B和接口1。再查找目的地址A。现在B1的转发表中可以查到A，其转发接口是1，和这个帧进入网桥B1的接口一样。于是网桥B1直到，不用自己转发这个帧，A也能收到B发送的帧。于是网桥B1把这个帧丢弃，不再继续转发了（即前面说的过滤）。这次网桥B1的转发表增加了一个项目，网桥B2的转发表没有变化

3、网桥与碰撞域

![p14]

如上图，不同网段上的通信不会相互干扰。例如，A和B正在通信，但其他网段上的C和D以及E和F也都可以同时通信。但如果A要和另一个网段上的C通信，就必须经过网桥B1的转发，那么这两个网桥上就不能再有其他的站点进行通信（这时，E和F仍然可以通信）