# 第 3 章 数据链路层 #

### 数据链路层的一些基本概念 ###

#### 数据链路层的地位 ####

下面简述两个主机通过互联网进行通信时数据链路层所处的地位

图（a）表示用户主机H1通过电话线上网，中间经过三个路由器连接到远程主机H2，并且经过了多种网络（电话网、局域网...）。当主机H1向H2发送数据时，从协议的层次上看，数据的流动如图（b）。主机都有完整的协议栈，路由器只拥有下面的三层协议栈。数据进入路由器后要先从物理层上升到网络层，在转发表中找到下一跳的地址后，再下到物理层转发出去（如图（b）中的箭头所示）

![p6]

但当我们研究数据链路层的问题时，我们可以只关心在协议栈中水平方向的各数据链路层。因此，当主机H1向H2发送数据时，我们可以想象数据就是在数据链路层从左到右依次传送，如下图：

![p7]

#### 数据链路层使用的信道 ####

数据链路层使用的信道主要有以下两种类型：

1、点对点信道

这种信道使用一对一的点对点通信方式（通信两点之间只有一条物理线路，没有其他任何结点）

2、广播信道

这种信道使用一对多的广播通信方式。广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据发送

#### 链路和数据链路 ####

1、链路

所谓链路就是从一个结点到相邻结点的一段物理线路，而中间没有任何其他的交换结点。在进行数据通信时，两个计算机间的通信路径往往要经过许多段这样的链路

2、数据链路

要想在一段链路上传送数据，那么还必须有一些必要的通信协议来控制这些数据的传输。若把实现这些协议的硬件或软件加到链路上，就构成了数据链路

### 数据链路层要解决的三个基本问题 ###

数据链路层要解决的三个基本问题是：封装成帧、透明传输、差错检测。下面分别阐述。

1、封装成帧

网络层的IP数据报传送到数据链路层就成为帧的数据部分，在帧的数据部分的前面和后面分别添加上首部和尾部，构成了一个完整的帧。如下图：

![p1]

由上图可见。帧长等于数据部分的长度加上帧首部和尾部的长度。在发送帧时，是从帧的首部开始发送。帧的数据部分的长度上限称为最大传输单元MTU

帧的首部和尾部的一个重要作用就是进行帧定界。一般以ASCLL表中的控制字符SOH与EOT作为帧的首部与尾部。控制字符SOH（Start Of Header)放在帧的最前面表示帧的首部，另一个控制字符EOT（End Of Transmission)表示帧的尾部（SOH与EOT是控制字符在ASCLL表中的名字，在实际的帧中他们分别以二进制`00000001`与`00000100`出现）。如下图所示：

![p2]

接收端在收到帧后，只有当帧的首部SOH和尾部EOT都健在时接收端才会认为这是一个完整的帧，应当收下。如果数据在传输过程中出现了错误，接收端收到的帧中缺少SOH或EOT，那么接收端就知道这不是一个完整的帧，应该丢弃。

2、透明传输

所谓透明传输就是指，无论何种数据都能使用“1、封装成帧”中的方式将其封装为帧进行传输。

要想做到透明传输，那么所传输的数据中的任何8比特的组合一定不允许和用作帧定界的控制字符的比特编码一样，否则就会出现帧定界错误。如下图所示，如果数据中的某个字节的二进制代码恰好和SOH或EOT这种控制字符一样，数据链路层就会错误的“找到帧边界”，把部分帧收下（误认为是一个完整的帧），而把剩下的那部分数据丢掉,这就是不透明传输。

![p3]

为了解决上述问题做到透明传输，就必须设法使数据中可能出现的控制字符SOH和EOT在接收端不被解释为帧定界符。具体方法是：发送端的数据链路层在数据中出现控制字符SOH和EOT的前面插入一个转义字符ESC。而在接收端的数据链路层在将数据送往网络层之前删除这个插入的转义字符。这种方法称为字节填充或字符填充。如果转义字符也出现在数据中，那么解决方法仍然是在转义字符前面再插入一个转义字符。因此，当接收端收到连续的两个转义字符时，就删除其中前面的一个。如下图：

![p4]

3、差错检测

现实中的通信线路不是理想的，因此比特在传输过程中可能会产生差错——即1可能变成0，0可能变成1。这就叫做比特差错。在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率BER（Bit Error Rate）。因此，为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测技术。目前在数据链路层广泛使用了循环冗余检验CRC（Cyclic Redundancy Check）的差错检测技术。

CRC的原理如下：

![p5]

上图中，A是由收发双发协商确定的n位二进制数，B是要发送的数据。CRC要做的就是在B后面添加“n-1”个0，然后用添加了0的数据除以A，得到余数D。D就被称为冗余码或帧检验序列FCS（Frame Check Sequence），在发送数据B时，就会将该冗余码添加到B后面发送出去（即实际发送的数据是`101001001`）。接收端收到数据后，会将数据以帧为单位进行CRC检验：把收到的每一个帧都除以A，然后检查得到的余数，如果余数为0则无差错，余数不为0则表示出错，就丢弃。

### 使用点对点信道的数据链路层 ###

下面介绍点对点协议PPP（Point-to-Point Protocol）。PPP是点对点通信时，数据链路层所使用的协议。具体来说就是用户计算机和ISP进行通信时所使用的数据链路层协议。

下面详述PPP的特点、帧格式、工作状态

#### PPP的特点 ####

1、PPP协议应满足的要求

(1)、封装成帧

PPP协议必须规定特殊的字符作为帧定界符，以便使接收端从收到的比特流中能够准确的找出帧开始和结束的位置

(2)、透明性

即如果数据中碰巧出现了和帧定界符一样的比特组合时，必须采取措施解决这个问题

(3)、多种网络层协议

PPP协议必须能够在同一条物理链路上同时支持多种网络层协议（如IP或IPX）的运行。即使用该条物理线路的两端可以使用任何网络层协议进行通信，比如一会儿使用的是IP，一会儿使用的是IPX

(4)、多种类型链路

即PPP能够在多种链路上运行（如光纤、双绞线等）

(5)、差错检测

即PPP能够对接收端收到的帧进行CRC差错检测并丢弃有差错的帧。需要注意的是，PPP只进行检错并丢弃错误包，但不进行纠错。因此PPP是不可靠传输协议

(6)、检测连接状态

即检测链路是否处于正常的工作状态

(7)、最大传送单元

即设置最大传送单元MTU的默认值

(8)、网络层地址协商

即能够协商通信双方网络层的地址

(9)、数据压缩协商

即协商使用何种数据压缩算法，以便接收方能够使用对应的方法解压

2、PPP不需要的功能

(1)、纠错。PPP只进行检错，纠错由TCP负责

(2)、流量控制。流量控制由TCP负责

3、PPP协议的组成

PPP协议由如下三部分组成：

(1)、高级数据链路控制协议HDLC（High-Level Data Link Control）。这是一种对来自网络层的数据进行帧封装的规范

(2)、用来建立、配置和测试数据链路连接的链路控制协议LCP（Link Control Protocol）

(3)、一套网络控制协议NCP（Network Control Protocol），其中的每一个协议支持不同的网络层协议，如IP、OSI的网络层。

![p8]

#### PPP的帧格式 ####

1、字段的意义

PPP的帧格式如下图所示。PPP帧的首部和尾部分别为四个字段和两个字段。

首部的第一个字段和尾部的倒数第一个字段都是标志字段F（Flag），规定为0X7E（0X表示十六进制）。标志字段表示一个帧的开始和结束，因此标志字段就是PPP帧的定界符

首部中的地址字段A规定为0XFF，控制字段C规定为0X0。但这两个字段在PPP帧中并没实际意义

首部的第四个字段是2字节的协议字段，用以标明“信息部分”中装的是什么数据（如协议字段为0X0021时，表明信息部分中装的是IP数据报；协议字段为0XC021时，表明信息部分中装的是LCP数据）

尾部中的倒数第二个字段是CRC的帧检验序列FCS

2、0比特/字节填充

当“信息部分”中出现和标志字段一样的比特组合时（0X7E），就必须采取一些措施使这种形式上和标志字段一样的比特组合不出现在信息部分中，方法就是字节/比特填充。这也就是前面所说的透明传输。

在PPP使用异步传输（逐个字符传送）和同步传输（一连串的比特连续传送）时，分别使用的是字节填充和比特填充。具体如下：

(1)、字节填充

当PPP使用异步传输时，它把转义符定义为0X7D，并使用字节填充。填充方法如下：

- 把信息字段中出现的每一个0X7E字节转变为2字节序列（0X7D，0X5E）
- 把信息字段中出现一个0X7D的字节（即出现了和转义字符一样的比特组合），则把0X7D转变为2字节序列（0X7D，0X5D）
- 若信息字段中出现ASCLL码的控制字符，则在该字符前面要加入一个0X7D字节，同时将该字符的编码加以改变

(2)、0比特填充

具体做法是：在发送端先扫描整个信息字段，只要发现有5个连续1，则立即填入一个0。接收端在收到一个帧时，先找到标志字段F以确定一个帧的边界，接着再用硬件对其中的比特流进行扫描，每当发现五个连续1时，就把这五个连续1后面的一个0删除，以还原为原来的数据。


