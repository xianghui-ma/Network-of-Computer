# 第 3 章 数据链路层 #

### 数据链路层要解决的三个基本问题 ###

数据链路层要解决的三个基本问题是：封装成帧、透明传输、差错检测。下面分别阐述。

1、封装成帧

网络层的IP数据报传送到数据链路层就成为帧的数据部分，在帧的数据部分的前面和后面分别添加上首部和尾部，构成了一个完整的帧。如下图：

![p1]

由上图可见。帧长等于数据部分的长度加上帧首部和尾部的长度。在发送帧时，是从帧的首部开始发送。帧的数据部分的长度上限称为最大传输单元MTU

帧的首部和尾部的一个重要作用就是进行帧定界。一般以ASCLL表中的控制字符SOH与EOT作为帧的首部与尾部。控制字符SOH（Start Of Header)放在帧的最前面表示帧的首部，另一个控制字符EOT（End Of Transmission)表示帧的尾部（SOH与EOT是控制字符在ASCLL表中的名字，在实际的帧中他们分别以二进制`00000001`与`00000100`出现）。如下图所示：

!p[2]

接收端在收到帧后，只有当帧的首部SOH和尾部EOT都健在时接收端才会认为这是一个完整的帧，应当收下。如果数据在传输过程中出现了错误，接收端收到的帧中缺少SOH或EOT，那么接收端就知道这不是一个完整的帧，应该丢弃。

2、透明传输

所谓透明传输就是指，无论何种数据都能使用“1、封装成帧”中的方式将其封装为帧进行传输。

要想做到透明传输，那么所传输的数据中的任何8比特的组合一定不允许和用作帧定界的控制字符的比特编码一样，否则就会出现帧定界错误。如下图所示，如果数据中的某个字节的二进制代码恰好和SOH或EOT这种控制字符一样，数据链路层就会错误的“找到帧边界”，把部分帧收下（误认为是一个完整的帧），而把剩下的那部分数据丢掉,这就是不透明传输。

![p3]

为了解决上述问题做到透明传输，就必须设法使数据中可能出现的控制字符SOH和EOT在接收端不被解释为帧定界符。具体方法是：发送端的数据链路层在数据中出现控制字符SOH和EOT的前面插入一个转义字符ESC。而在接收端的数据链路层在将数据送往网络层之前删除这个插入的转义字符。这种方法称为字节填充或字符填充。如果转义字符也出现在数据中，那么解决方法仍然是在转义字符前面再插入一个转义字符。因此，当接收端收到连续的两个转义字符时，就删除其中前面的一个。如下图：

![p4]

3、差错检测

现实中的通信线路不是理想的，因此比特在传输过程中可能会产生差错——即1可能变成0，0可能变成1。这就叫做比特差错。在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率BER（Bit Error Rate）。因此，为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测技术。目前在数据链路层广泛使用了循环冗余检验CRC（Cyclic Redundancy Check）的差错检测技术。

CRC的原理如下：

![p5]

上图中，A是由收发双发协商确定的n位二进制数，B是要发送的数据。CRC要做的就是在B后面添加“n-1”个0，然后用添加了0的数据除以A，得到余数D。D就被称为冗余码或帧检验序列FCS（Frame Check Sequence），在发送数据B时，就会将该冗余码添加到B后面发送出去（即实际发送的数据是`101001001`）。接收端收到数据后，会将数据以帧为单位进行CRC检验：把收到的每一个帧都除以A，然后检查得到的余数，如果余数为0则无差错，余数不为0则表示出错，就丢弃。

