# 第 5 章 运输层 #

### 运输层概述 ###

#### 运输层与网络层的区别 ####

区别是：网络层实现的是主机到主机的通信，而运输层实现的是端到端的通信（即两主机进程到进程间的通信）。具体释义如下：

两个主机的通信实际上是两个主机中的相应进程相互通信。而IP协议只是将分组送到目的主机，但这个分组还停留在主机的网络层而没有交付给主机中对应的应用进程。此时，便需要运输层将停留在网络层的数据正确交付到目的应用进程（即运输层的“分用”功能）

> 只有网络上的主机才有运输层，路由器只有`网络层、数据链路层、物理层`

#### 运输层的两个主要协议 ####

- 用户数据报协议UDP（User Datagram Protocol）
- 传输控制协议TCP（Transmission Control Protocol）

#### 端口 ####

1、端口的作用

上面已经说到——分组到达网络层后，需要由运输层将数据交给对应进程。那么问题是运输层怎么知道交给哪个进程呢？

解决办法就是使用端口（号）

端口介于运输层与应用层之间，用于标识应用层中的各个进程。两个计算机在进行通讯时，需要知道彼此的IP地址与端口号，从而运输层便能根据网络层交上来的数据中的端口号将数据交给相应进程

2、端口的分类

- 服务器端使用的端口号（取值为`0~1023`）。这些端口号被指派给服务器端的应用进程，各自就固定代表相应进程。如下为一些常用的服务器端口号：

![p1]

- 客户端使用的端口号（取值为`49152~65535`）。这些端口号是留给客户主机的进程使用的。当一个进程被创建时系统为其随机分配一个端口号。当该进程被关闭后，它的端口号也被回收给其他进程使用

运输层概述叙述完后，下面便开始正式讨论运输层的两个主要协议

### 用户数据报协议UDP ###

1、UDP的特点

- UDP是无连接的。即发送数据之前不需要先建立连接（当然，发送数据结束后也没有连接可释放）
- UDP不保证可靠交付（因此主机不需要维护连接状态表）
- UDP是面向报文的。UDP对应用层交下来的报文，既不合并，也不拆分，而是在添加UDP首部后便将整个报文交给IP层（如果报文太长，IP层自己知道分片（第4章中我们讨论了分片））。UDP对IP层交上来的报文，在去除UDP首部后便将整个数据部分交给应用层。综上，UDP一次交付一个完整的报文
- UDP没有拥塞控制。因此，网络出现的拥塞不会使源主机的发送速率降低（UDP的该特性正好适合于某些实时应用，如视频会议，它允许在网络发生拥塞时丢失部分数据，但不允许有太大的时延）
- UDP支持一对一，一对多，多对一，多对多的通信

2、UDP的首部格式

UDP的首部由四个字段组成，每个字段两字节。各字段如下：

- 源端口（号）。在需要对方回信时选用，不需要时可用全0
- 目的端口（号）。这在终点交付报文时必须要使用到
- 长度。UDP用户数据报的长度
- 校验和。用于检测UDP用户数据报在传输过程中是否有错，有错就丢弃

![p2]

当运输层从IP层收到UDP数据报时，就根据首部中的目的端口，把UDP数据报通过相应的端口，上交最后的终点——应用进程。如果接收方UDP发现收到的报文中的目的端口号不正确（即不存在对应于该端口号的应用进程），就丢弃该报文，并由ICMP发送“端口不可达”差错报文给发送方

UDP在收到网络层交上来的UDP报文后，会对报文进行差错检测，检测方法是：首先在UDP报文前加上“伪首部”（如上图），然后对加上伪首部的整个UDP报文计算校验和。可见，UDP的校验和不仅仅检验首部，还检验数据部分。而第四章中的IP数据报仅检验首部

### 传输控制协议TCP ###

#### TCP的特点 ####

- TCP是面向连接的。即应用程序在使用TCP协议之前，必须先建立TCP连接。在传送数据完毕后，必须释放已经建立的TCP连接
- 每一个TCP连接只有两个端点（即TCP连接是一对一的）
- TCP提供可靠交付。即通过TCP连接传送的数据，无差错、不丢失、不重复、并且按序到达
- TCP提供全双工通信。TCP连接的两端都设有发送缓存和接收缓存，用来临时存放通信的数据。在发送时，进程将数据传给TCP缓存后，就可以做自己的事情了，TCP自己会择机把数据发送出去。在接收时，TCP将收到的数据放入缓存，上层的进程在合适的时候读取缓存中的数据

#### 套接字（socket） ####

在上面的“TCP的特点”中我们已经知道——每一个TCP连接有两个端点。实际上，TCP连接的端点就叫“套接字”

套接字由IP地址加端口号组成，即`套接字=IP:端口号`（如`192.3.4.5:80`就是一个套接字）

每一个TCP连接唯一的被通信两端的两个端点（即两个套接字）所确定，即`TCP连接={(IP1:port1), (IP2:port2)}`(IP1/2是两个端点主机的IP地址，port1/2是两个端点主机中的端口号)