# 第 4 章 网络层 #

### 因特网的设计思路 ###

因特网的设计思路是：网络层仅向上层提供无连接的、尽最大努力交付的数据报服务。

该种设计思路的特点如下：

| 项目 | 特点 |
| :----: | :----: |
| 连接的建立 | 通信双方不需要建立连接，路由器会根据数据报中的目的地址将数据报路由到目的地 |
| 终点地址 | 每个数据报都有终点的完整地址，因为路由器需要根据终点地址选择路径 |
| 分组的转发 | 每个分组独立选择路由进行转发（见下图） |
| 当结点出现故障时 | 出现故障的结点可能会丢失分组，分组也可以寻找其他路径以避开故障结点 |
| 分组的顺序 | 各分组到达终点的顺序不一定与与发送顺序保持一致，是随机的 |
| 可靠交付 | 网络层不提供可靠交付，可靠交付由端系统负责 |

下图便展示了主机H1向H2通信发送的分组各自独立的选择路由，并且在传输过程中还可能丢失

![p1]

### 虚拟互联网络 ###

如第一章中所述——互联网就是用路由器将全球的所有网络连起来构成的一个网络。但是问题是，被连起来的各网络是异构的（如所采取的网络协议是不一致的），那么这些异构的网络是不能直接相互通信的，要想实现相互间的通信则必然十分复杂。

为了解决上述问题，便引入了网际协议IP。即参加互连的网络的网络层都使用网际协议IP，如此以来便可以用网际协议IP实现异构网络间的通信了（各网络的异构性仍然存在，只是有了网际协议IP作为交流平台）

由于各异构网络都使用网际协议IP，因此它们间便可以实现无障碍通信，就如同在各自所在的网络中通信一样，因此整个互联网就如同一个网络，而这个网络就是虚拟互联网络（或逻辑互连网络）

如下图中的（a)表示路由器连接各异构网络而成的互联网，（b）表示虚拟互连网络

![p2]

### IP地址 ###

IP地址的作用对象是网络上的主机或路由器，以标识它们

IP地址的编制方法有三类：

- 分类的IP地址。这是最基本的编址方法
- 子网的划分。这是对基本编址方法的改进
- 构成超网。较新的无分类编址方法

下面对各种编址方法的IP地址进行讨论

#### 分类的IP地址 ####

1、各类IP地址的结构

该种方法将IP地址分为A、B、C、D、E五类，每类由网络号和主机号两个字段构成，网络号用于标识主机（或路由器）所连接到的网络，主机号用于标识该主机（或路由器）：

![p3]

一个网络号在整个因特网范围内必须是唯一的；一个主机号在网络号所指明的网络范围内必须是唯一的。我们还将网络号视为一个网段（这时IP地址意义上的网段，注意与第三章中的网段概念相区分），若几个主机的网络号一致，则意味着他们在同一个网段

> 地址分配机构只负责分配网络号，剩下的主机号则由得到该网络号的单位自行分配

2、各类IP地址的范围

(1)、A类IP地址

A类IP地址的网络字段占一个字节（第一位固定为0），故可指派的网络号个数是`2^7 - 2`。减2是因为：网络字段为全0的IP地址是一个保留地址，表示本网络；网络号为127（即01111111）作为本地软件环回测试之用（即本主机的进程之间的通信之用），若主机发送一个IP地址为环回地址的IP数据报，则本主机中的协议软件就处理数据报中的数据，而不把数据发送到任何网络（比如我们使用本地wampsever做测试时，访问地址就是127.0.0.1）。目的地址为环回地址的IP数据报永远不会出现在任何网络上，因为网络号为127的地址根本不是一个网络地址。

A类IP地址的主机字段占三个字节，故A类网络中的最大主机数是`2^24 - 2`。减2是因为：全0的主机号字段表示该IP地址是本主机所连接到的网络地址（如5.0.0.0可表示5.x.x.x的网络地址）；全1的主机号字段表示该网络上的所有主机

(2)、B类IP地址

B类IP地址的网络字段占两个字节（前两位固定为10），且128.0.0.0不被指派，因此可指派的网络号个数是`2^14 - 1`

B类IP地址的主机字段占两个字节，故B类网络中的最大主机数是`2^16 - 2`(扣除全0与全1的主机号)

(3)、C类IP地址

C类IP地址的网络字段占三个字节（前三位固定为110），且192.0.0.0不被指派，因此可指派的网络号个数是`2^21 - 1`

C类IP地址的主机字段占一个字节，故C类网络中的最大主机数是`2^8 - 2`(扣除全0与全1的主机号)

> A、B、C都要扣除全0与全1的主机号

至此，“分类的IP地址”便已阐述完毕，下面通过一张图补充一些关于分类IP地址的其他知识点：

![p4]

上图展示的是路由器将几个局域网连接为一个互联网。我想补充的是：

- 在同一个局域网上的主机或路由器的IP地址中的网络号必须是一样的
- 一个主机或路由器可以同时具有多个IP地址。如一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的IP地址，又如上图中所示的路由器，其每个接口都有一个IP地址，且由于路由器就是用于连接不同网络的，因此其至少有两个IP地址
- 当两个路由器直接相连时，在连线两端的接口处可以分配也可以不分配IP地址，现在一般不分配IP地址
- 用网桥互联的网段仍然是一个局域网，只能有一个网络号

### IP地址与硬件地址 ###

在此主要讲述IP地址与硬件地址的区别，具体内容如下：

IP地址是网络层及网络层以上的各层所使用的地址，MAC地址是数据链路层及数据链路层以下的各层所使用的地址。意即，各主机间的通信信息最终都会被封装为MAC帧在数据链路上传输，且MAC帧在传输过程中使用的是MAC地址而不是IP地址

以下图为例进行说明：

![p5]

从上到下，

主机H1与主机H2通信

网络层的IP数据报传递到数据链路层，数据链路层将IP数据报封装为MAC帧且IP数据报就是该MAC帧的数据部分，同时会在MAC帧的首部添加源主机的MAC地址与目的主机的MAC地址

然后H1将MAC帧送至网络上向H2传送。在传送过程中，每一跳都会改变MAC帧首部中的源MAC地址与目的MAC地址。如，由H1向路由器R1传送时，MAC帧中的源MAC地址与目的MAC地址分别为HA1与HA3；由路由器R1向R2传送时，MAC帧中的源MAC地址与目的MAC地址分别被更改为HA4与HA5。但是，值得注意的是，在传输过程中，IP数据报中的源IP地址与目的IP地址是不会改变的。

> 路由器的每个接口都有一个MAC地址与IP地址

### 地址解析协议ARP ###

在前面的`IP地址与硬件地址`一节中，我们已经知道数据最终都会被封装为MAC帧在网络上传输。但这儿有一个问题是：封装MAC帧时，MAC帧中的源MAC地址与目的MAC地址是怎么来的呢？本节所述内容便能对此进行解答。

地址解析协议ARP的作用是将IP地址解析为对应的MAC地址（对应还有逆地址解析协议RARP，作用是将MAC地址解析为对应的IP地址，不过在此不对其进行介绍）

在封装MAC帧时，会使用ARP将源IP地址与目的IP地址解析为对应的MAC地址。然后将其封装为MAC帧中的目的MAC地址

ARP实现的方式是：每一个主机都设有ARP高速缓存，里面便存有本局域网上的各主机和路由器的IP地址到硬件地址的映射表。如果在解析某个目的IP地址时，缓存中没有对应的这样一条IP到MAC的映射，那么主机就会自动向该局域网上广播发送一个ARP请求分组——问“我想知道IP地址为X.X.X.X的主机的硬件地址”，目的主机在请求分组中发现有自己的IP地址，于是就将自己的MAC帧发送给询问方（此时不是广播发送，而是一对一的发送）

> 特别注意：ARP是解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题

### 路由器IP层转发分组的流程 ###

在`IP地址与硬件地址`一节中，我们知道，一个路由器将MAC帧交给另一个路由器时，MAC帧中的源MAC地址和目的MAC地址都会被更改。但这儿还有一个问题是：要想得到目的MAC地址，那么就必须先得到目的路由器的IP地址，然后才能用ARP将目的路由器的IP地址解析为目的MAC地址，那么路由器是怎么得到目的路由器的IP地址的呢？

解决方法就是：路由器通过自己的路由表映射到下一跳路由器的IP地址

下面举例说明。如下图：

![p6]

假设路由器R1要将它收到的MAC帧转发到网4。路由器R1收到MAC帧后，从IP数据报中的目的主机的IP地址得到目的主机所在的网络(即网络号，获取方法是将IP数据报中的目的IP地址与子网掩码做与运算（子网掩码就存储在路由表中，上图未写出来，具体见下面`子网掩码`小节）)，然后通过查找路由表得到下一跳路由器的IP地址为`20.0.0.9`（路由器R2），然后通过ARP将`20.0.0.9`解析为目的MAC地址并更改收到的MAC帧中的目的MAC地址。R2收到MAC帧后做同样的操作

> 在此对`IP地址与硬件地址、地址解析协议ARP、路由器IP层转发分组的流程`这三节的逻辑关系进行梳理：路由器通过IP数据报中的目的IP地址得到目的主机所在的网络，并通过查找自己的路由表得到下一跳的目的IP地址（对应于`路由器IP层转发分组的流程`）——>然后通过ARP将目的IP解析为MAC地址并作为MAC帧中的目的MAC地址（对应于`地址解析协议ARP`）——>有了目的MAC地址，MAC帧便能在数据链路上传输了（对应于`IP地址与硬件地址`）

### IP数据报的组成格式 ###

IP数据报的完整格式如下图所示：

![p7]

由上图可知，IP数据报由首部和数据部分两部分构成。其中，首部又由固定部分和可变部分两部分组成，且固定部分是所有IP数据报必须具有的。下面对首部中的固定部分的各字段进行介绍：

1、版本

占4位。目前广泛使用的是IPv4，IPv6也在逐步推广中。通信双方所示用的IP协议版本必须一致

2、首部长度、填充

首部长度占4位。单位是“32位字”(即如首部长度为1111时，十进制为15，即15个32位字，而一个32位字为4字节，即1111便表示该IP数据报的首部占15 x 4 = 60字节)。可见首部长度一定是4的倍数。倘若IP数据报的首部长度不是4的倍数，那么便利用后面的填充字段进行填充，直到填到4的倍数

3、区分服务

一般不用

4、总长度

占16位，单位为字节。表示整个IP数据报的长度(即首部长度加数据部分)

由于IP数据报传递到数据链路层时，会作为MAC帧的数据部分，因此IP数据报的总长度不能大于数据链路层的MTU

5、标识

占16位。IP软件会维持一个计数器，IP软件每生成一个IP数据报计数器便会加1，并将计数器的值放入IP数据报的标识字段

若数据报进行了分片，那么这个标识字段的值就被复制到所有分片的标识字段中，各分片拥有一致的标识字段就表示他们来自于同一个IP数据报

6、标志

占3位。但目前只有两位有意义

标志字段的最低位记为MF(More Fragment)。MF为1时表示后面还有分片，MF为0时表示这已是数据报分片中的最后一个
标志字段的中间一位记为DF(Don't Fragment)，表示不能分片，仅当DF为0时才允许分片

7、片偏移

占13位

4中我们说到，IP数据报的长度不能超过数据链路层的MTU。因此，若一个IP数据报超过了MTU，那么就会将其分片，拆为多个IP数据报，这就是分片。

片偏移是相对于IP数据报的数据部分的起点计算的，用以表示该分片是距起点多长处被分离的。偏移量以“8字节”为单位，即分片的长度一定是8字节的整数倍

接收端在收到这些分片后，通过标识字段便可知道它们来自同一个IP数据报，又通过片偏移字段的大小来确定各分片的组装顺序(偏移量越多越靠后)

8、生存时间

占8位。其作为跳数限制，表示该数据报经过生存时间指定的跳数后便被丢弃。这样做是为了防止无法交付的数据在网络中兜圈子。可见一个数据报最多能经历255跳

9、协议

占8位。表示该数据报所携带的数据使用的是何种协议，以便交给上层对应的进程

10、首部校验和

占16位。仅校验数据报的首部，不校验数据部分。每过一个路由器，路由器都会校验首部校验和，若首部发生了变化，则该数据报便被丢弃

11、源地址、目的地址

源地址、目的地址都是IP地址，不是MAC地址

### 划分子网 ###

#### 为什么要划分子网 ####

- IP地址空间的利用率有时很低
- 两级IP地址不够灵活

#### 如何划分子网 ####

划分子网的方法是从IP地址的主机号中借用若干位作为子网号。如此以来，IP地址就由原来的二级（`网络号 + 主机号`）变为三级（`网络号 + 子网号 + 主机号`）了

下面举例说明如何划分子网

![p8]

上图展示了一个网络号为`145.13`的B类IP地址，我们从该IP地址的主机号中借用8位（即一个字节）作为子网号，并划分出了`145.13.3、145.13.7、145.13.21`三个子网

#### 子网的特性 ####

- 一个网络划分子网后，该网络之外的其他网络并不知道该网络划分了子网，即该网络对外仍表现为一个网络。如上例中，`145.13`之外的网络不知道该网络划分有三个子网，该网络对外仍表现为`145.13`
- 一个网络划分子网后，该网络仍采用同以前一样的方式接受其他网络的信息。唯一不同的是，该网络的路由器在收到信息后还需要根据IP数据报中的目的IP地址找到信息属于哪个子网，然后才交付数据

#### 子网掩码 ####

划分子网需要解决的一个问题是：路由器在收到信息后如何根据IP数据报中的目的IP地址找到信息属于哪个子网？

解决这个问题的方法是：给每个子网设置一个子网掩码，然后将IP数据报中的目的IP地址与子网掩码进行与运算，从而得到目的子网的网络号，这样路由器就能将信息转发到对应子网中去了

还是以上图为例。现假设有一个MAC帧（其目的地址为`145.13.3.10`）到达了路由器R1，那么这个路由器如何将其转发到子网`145.13.3`呢？（即路由器如何获得子网网络号`145.13.3`？）

如下图，将子网`145.13.3`的子网掩码`255.255.255.0`同IP数据报中的目的IP地址进行与运算即可

![p9]

### ICMP协议 ###

1、ICMP协议是什么

网际控制报文协议（Internet Control Message Protocol）ICMP是网络层协议。作用是，被主机或路由器用来报告差错情况（白话讲就是：数据传送失败时，用它来报告失败原因），以便数据发送端通过差错原因做相应传输调整，从而保证数据准确到达

2、ICMP报文的结构

![p10]

如上图，ICMP报文由12个字节组成。前4个字节为`类型（1个字节）、代码（1个字节）、校验和（2个字节）`；中间4个字节取决于ICMP报文的类型；最后四个字节是ICMP报文的数据部分

可见，当传输出错时，出错处的主机或路由器会将出错信息封装为一个ICMP报文，然后将该ICMP报文作为IP数据报的数据部分，然后再发给数据源端，以告知源端错误原因

> 上图中虽显示IP数据报的数据部分是ICMP报文，但是不要被此误导认为“主机发送用户数据时也是将用户数据封装为ICMP报文，然后将该ICMP报文作为IP数据报的数据部分进行发送”。只有当传输出错时，出错处的主机或路由器会将出错信息封装为一个ICMP报文

3、ICMP报文的种类

![p11]

如上图所示，ICMP报文分为差错报告报文和询问报文两大类

差错报告报文的五个小类为：

- 终点不可达。当路由器或主机不能交付数据报时，就向源点发送终点不可达报文
- 源点抑制。当路由器或主机由于拥塞而丢失数据报时，就向源点发送源点抑制报文，使源点直到应该把数据报的发送速率放慢
- 时间超过。当路由器收到生存时间为0的数据报时，除丢弃该数据包外，还要向源点发送时间超过报文
- 参数问题。当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文
- 改变路由。路由器把改变路由报文发送给主机，让主机知道下次应该将数据报发送给另外的路由器

询问报文的两小类为：

- 回送请求和回答（这是两个报文，即回送请求报文和回送回答报文）。ICMP回送请求报文是由主机或路由器向某一个主机发出的询问。收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。这种回送请求和回答报文往往用来测试两个主机间的连通性。如我们常用的`ping`命令使用的就是它们
- 时间戳请求和回答。ICMP时间戳请求报文是请某个主机或路由器回答当前的日期和时间

